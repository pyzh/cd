<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html xmlns:erl="http://erlang.org" xmlns:fn="http://www.w3.org/2005/02/xpath-functions">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="../otp_doc.css" type="text/css">
<title>Erlang -- gen_fsm Behaviour</title>
</head>
<body bgcolor="white" text="#000000" link="#0000ff" vlink="#ff00ff" alink="#ff0000"><div id="container">
<script id="js" type="text/javascript" language="JavaScript" src="../js/flipmenu/flipmenu.js"></script><script id="js2" type="text/javascript" src="../js/erlresolvelinks.js"></script><script language="JavaScript" type="text/javascript">
            <!--
              function getWinHeight() {
                var myHeight = 0;
                if( typeof( window.innerHeight ) == 'number' ) {
                  //Non-IE
                  myHeight = window.innerHeight;
                } else if( document.documentElement && ( document.documentElement.clientWidth ||
                                                         document.documentElement.clientHeight ) ) {
                  //IE 6+ in 'standards compliant mode'
                  myHeight = document.documentElement.clientHeight;
                } else if( document.body && ( document.body.clientWidth || document.body.clientHeight ) ) {
                  //IE 4 compatible
                  myHeight = document.body.clientHeight;
                }
                return myHeight;
              }

              function setscrollpos() {
                var objf=document.getElementById('loadscrollpos');
                 document.getElementById("leftnav").scrollTop = objf.offsetTop - getWinHeight()/2;
              }

              function addEvent(obj, evType, fn){
                if (obj.addEventListener){
                obj.addEventListener(evType, fn, true);
                return true;
              } else if (obj.attachEvent){
                var r = obj.attachEvent("on"+evType, fn);
                return r;
              } else {
                return false;
              }
             }

             addEvent(window, 'load', setscrollpos);

             //--></script><div id="leftnav"><div class="innertube">
<img alt="Erlang logo" src="../erlang-logo.png"><br><small><a href="users_guide.html">User's Guide</a><br><a href="../pdf/otp-system-documentation-8.3.5.4.pdf">PDF</a><br><a href="../index.html">Top</a></small><p><strong>OTP Design Principles</strong><br><strong>User's Guide</strong><br><small>Version 8.3.5.4</small></p>
<br><a href="javascript:openAllFlips()">Expand All</a><br><a href="javascript:closeAllFlips()">Contract All</a><p><small><strong>Chapters</strong></small></p>
<ul class="flipMenu" imagepath="../js/flipmenu">
<li id="no" title="Overview" expanded="false">Overview<ul>
<li><a href="des_princ.html">
              Top of chapter
            </a></li>
<li title="Supervision Trees"><a href="des_princ.html#idp25673984">Supervision Trees</a></li>
<li title="Behaviours"><a href="des_princ.html#idp25666480">Behaviours</a></li>
<li title="Applications"><a href="des_princ.html#idp25609712">Applications</a></li>
<li title="Releases"><a href="des_princ.html#idp25603392">Releases</a></li>
<li title="Release Handling"><a href="des_princ.html#idp25599968">Release Handling</a></li>
</ul>
</li>
<li id="no" title="gen_server Behaviour" expanded="false">gen_server Behaviour<ul>
<li><a href="gen_server_concepts.html">
              Top of chapter
            </a></li>
<li title="Client-Server Principles"><a href="gen_server_concepts.html#idp25590128">Client-Server Principles</a></li>
<li title="Example"><a href="gen_server_concepts.html#idp25586704">Example</a></li>
<li title="Starting a Gen_Server"><a href="gen_server_concepts.html#idp25580048">Starting a Gen_Server</a></li>
<li title="Synchronous Requests - Call"><a href="gen_server_concepts.html#idp25752064">Synchronous Requests - Call</a></li>
<li title="Asynchronous Requests - Cast"><a href="gen_server_concepts.html#idp25726272">Asynchronous Requests - Cast</a></li>
<li title="Stopping"><a href="gen_server_concepts.html#idp25763056">Stopping</a></li>
<li title="Handling Other Messages"><a href="gen_server_concepts.html#idp24281392">Handling Other Messages</a></li>
</ul>
</li>
<li id="loadscrollpos" title="gen_fsm Behaviour" expanded="true">gen_fsm Behaviour<ul>
<li><a href="fsm.html">
              Top of chapter
            </a></li>
<li title="Finite-State Machines"><a href="fsm.html#idp25298816">Finite-State Machines</a></li>
<li title="Example"><a href="fsm.html#idp24804416">Example</a></li>
<li title="Starting gen_fsm"><a href="fsm.html#idp24621488">Starting gen_fsm</a></li>
<li title="Notifying about Events"><a href="fsm.html#idp24412112">Notifying about Events</a></li>
<li title="Time-Outs"><a href="fsm.html#idp24409904">Time-Outs</a></li>
<li title="All State Events"><a href="fsm.html#idp25748400">All State Events</a></li>
<li title="Stopping"><a href="fsm.html#idp25589072">Stopping</a></li>
<li title="Handling Other Messages"><a href="fsm.html#idp25500848">Handling Other Messages</a></li>
</ul>
</li>
<li id="no" title="gen_statem Behavior" expanded="false">gen_statem Behavior<ul>
<li><a href="statem.html">
              Top of chapter
            </a></li>
<li title="Event-Driven State Machines"><a href="statem.html#idp25616400">Event-Driven State Machines</a></li>
<li title="Callback Modes"><a href="statem.html#idp25627376">Callback Modes</a></li>
<li title="State Enter Calls"><a href="statem.html#idp26110704">State Enter Calls</a></li>
<li title="Actions"><a href="statem.html#idp26115520">Actions</a></li>
<li title="Event Types"><a href="statem.html#idp26135104">Event Types</a></li>
<li title="Example"><a href="statem.html#idp26153456">Example</a></li>
<li title="Starting gen_statem"><a href="statem.html#idp25153024">Starting gen_statem</a></li>
<li title="Handling Events"><a href="statem.html#idp26171584">Handling Events</a></li>
<li title="State Time-Outs"><a href="statem.html#idp26186608">State Time-Outs</a></li>
<li title="All State Events"><a href="statem.html#idp26192320">All State Events</a></li>
<li title="One Event Handler"><a href="statem.html#idp26199024">One Event Handler</a></li>
<li title="Stopping"><a href="statem.html#idp26204160">Stopping</a></li>
<li title="Event Time-Outs"><a href="statem.html#idp26221504">Event Time-Outs</a></li>
<li title="Erlang Timers"><a href="statem.html#idp26230976">Erlang Timers</a></li>
<li title="Postponing Events"><a href="statem.html#idp26242832">Postponing Events</a></li>
<li title="State Entry Actions"><a href="statem.html#idp26267184">State Entry Actions</a></li>
<li title="Self-Generated Events"><a href="statem.html#idp26278208">Self-Generated Events</a></li>
<li title="Example Revisited"><a href="statem.html#idp26290032">Example Revisited</a></li>
<li title="Filter the State"><a href="statem.html#idp26305968">Filter the State</a></li>
<li title="Complex State"><a href="statem.html#idp26315504">Complex State</a></li>
<li title="Hibernation"><a href="statem.html#idp26334912">Hibernation</a></li>
</ul>
</li>
<li id="no" title="gen_event Behaviour" expanded="false">gen_event Behaviour<ul>
<li><a href="events.html">
              Top of chapter
            </a></li>
<li title="Event Handling Principles"><a href="events.html#idp26355952">Event Handling Principles</a></li>
<li title="Example"><a href="events.html#idp26362208">Example</a></li>
<li title="Starting an Event Manager"><a href="events.html#idp26367184">Starting an Event Manager</a></li>
<li title="Adding an Event Handler"><a href="events.html#idp26374224">Adding an Event Handler</a></li>
<li title="Notifying about Events"><a href="events.html#idp26384720">Notifying about Events</a></li>
<li title="Deleting an Event Handler"><a href="events.html#idp26393216">Deleting an Event Handler</a></li>
<li title="Stopping"><a href="events.html#idp26402640">Stopping</a></li>
<li title="Handling Other Messages"><a href="events.html#idp26409168">Handling Other Messages</a></li>
</ul>
</li>
<li id="no" title="Supervisor Behaviour" expanded="false">Supervisor Behaviour<ul>
<li><a href="sup_princ.html">
              Top of chapter
            </a></li>
<li title="Supervision Principles"><a href="sup_princ.html#idp26422048">Supervision Principles</a></li>
<li title="Example"><a href="sup_princ.html#idp26424944">Example</a></li>
<li title="Supervisor Flags"><a href="sup_princ.html#idp26433616">Supervisor Flags</a></li>
<li title="Restart Strategy"><a href="sup_princ.html#idp26441552">Restart Strategy</a></li>
<li title="Maximum Restart Intensity"><a href="sup_princ.html#idp26456624">Maximum Restart Intensity</a></li>
<li title="Child Specification"><a href="sup_princ.html#idp26465776">Child Specification</a></li>
<li title="Starting a Supervisor"><a href="sup_princ.html#idp26518608">Starting a Supervisor</a></li>
<li title="Adding a Child Process"><a href="sup_princ.html#idp26532608">Adding a Child Process</a></li>
<li title="Stopping a Child Process"><a href="sup_princ.html#idp26537872">Stopping a Child Process</a></li>
<li title="Simplified one_for_one Supervisors"><a href="sup_princ.html#idp26544864">Simplified one_for_one Supervisors</a></li>
<li title="Stopping"><a href="sup_princ.html#idp26560224">Stopping</a></li>
</ul>
</li>
<li id="no" title="sys and proc_lib" expanded="false">sys and proc_lib<ul>
<li><a href="spec_proc.html">
              Top of chapter
            </a></li>
<li title="Simple Debugging"><a href="spec_proc.html#idp26572048">Simple Debugging</a></li>
<li title="Special Processes"><a href="spec_proc.html#idp26582144">Special Processes</a></li>
<li title="User-Defined Behaviours"><a href="spec_proc.html#idp26657440">User-Defined Behaviours</a></li>
</ul>
</li>
<li id="no" title="Applications" expanded="false">Applications<ul>
<li><a href="applications.html">
              Top of chapter
            </a></li>
<li title="Application Concept"><a href="applications.html#idp26693648">Application Concept</a></li>
<li title="Application Callback Module"><a href="applications.html#idp26701712">Application Callback Module</a></li>
<li title="Application Resource File"><a href="applications.html#idp26716784">Application Resource File</a></li>
<li title="Directory Structure"><a href="applications.html#idp26747136">Directory Structure</a></li>
<li title="Application Controller"><a href="applications.html#idp26798016">Application Controller</a></li>
<li title="Loading and Unloading Applications"><a href="applications.html#idp26801984">Loading and Unloading Applications</a></li>
<li title="Starting and Stopping Applications"><a href="applications.html#idp26809440">Starting and Stopping Applications</a></li>
<li title="Configuring an Application"><a href="applications.html#idp26819952">Configuring an Application</a></li>
<li title="Application Start Types"><a href="applications.html#idp26844928">Application Start Types</a></li>
</ul>
</li>
<li id="no" title="Included Applications" expanded="false">Included Applications<ul>
<li><a href="included_applications.html">
              Top of chapter
            </a></li>
<li title="Introduction"><a href="included_applications.html#idp26862224">Introduction</a></li>
<li title="Specifying Included Applications"><a href="included_applications.html#idp26870080">Specifying Included Applications</a></li>
<li title="Synchronizing Processes during Startup"><a href="included_applications.html#idp26873120">Synchronizing Processes during Startup</a></li>
</ul>
</li>
<li id="no" title="Distributed Applications" expanded="false">Distributed Applications<ul>
<li><a href="distributed_applications.html">
              Top of chapter
            </a></li>
<li title="Introduction"><a href="distributed_applications.html#idp26901232">Introduction</a></li>
<li title="Specifying Distributed Applications"><a href="distributed_applications.html#idp26905536">Specifying Distributed Applications</a></li>
<li title="Starting and Stopping Distributed Applications"><a href="distributed_applications.html#idp26929216">Starting and Stopping Distributed Applications</a></li>
<li title="Failover"><a href="distributed_applications.html#idp26941904">Failover</a></li>
<li title="Takeover"><a href="distributed_applications.html#idp26959584">Takeover</a></li>
</ul>
</li>
<li id="no" title="Releases" expanded="false">Releases<ul>
<li><a href="release_structure.html">
              Top of chapter
            </a></li>
<li title="Release Concept"><a href="release_structure.html#idp26984112">Release Concept</a></li>
<li title="Release Resource File"><a href="release_structure.html#idp26990400">Release Resource File</a></li>
<li title="Generating Boot Scripts"><a href="release_structure.html#idp27007504">Generating Boot Scripts</a></li>
<li title="Creating a Release Package"><a href="release_structure.html#idp27020336">Creating a Release Package</a></li>
<li title="Directory Structure"><a href="release_structure.html#idp27040352">Directory Structure</a></li>
</ul>
</li>
<li id="no" title="Release Handling" expanded="false">Release Handling<ul>
<li><a href="release_handling.html">
              Top of chapter
            </a></li>
<li title="Release Handling Principles"><a href="release_handling.html#idp27069600">Release Handling Principles</a></li>
<li title="Requirements"><a href="release_handling.html#idp27100288">Requirements</a></li>
<li title="Distributed Systems"><a href="release_handling.html#idp27111008">Distributed Systems</a></li>
<li title="Release Handling Instructions"><a href="release_handling.html#idp27114160">Release Handling Instructions</a></li>
<li title="Application Upgrade File"><a href="release_handling.html#idp27181632">Application Upgrade File</a></li>
<li title="Release Upgrade File"><a href="release_handling.html#idp27205184">Release Upgrade File</a></li>
<li title="Installing a Release"><a href="release_handling.html#idp27224128">Installing a Release</a></li>
<li title="Updating Application Specifications"><a href="release_handling.html#idp27284304">Updating Application Specifications</a></li>
</ul>
</li>
<li id="no" title="Appup Cookbook" expanded="false">Appup Cookbook<ul>
<li><a href="appup_cookbook.html">
              Top of chapter
            </a></li>
<li title="Changing a Functional Module"><a href="appup_cookbook.html#idp27308224">Changing a Functional Module</a></li>
<li title="Changing a Residence Module"><a href="appup_cookbook.html#idp27310512">Changing a Residence Module</a></li>
<li title="Changing a Callback Module"><a href="appup_cookbook.html#idp27315616">Changing a Callback Module</a></li>
<li title="Changing Internal State"><a href="appup_cookbook.html#idp27322048">Changing Internal State</a></li>
<li title="Module Dependencies"><a href="appup_cookbook.html#idp27339392">Module Dependencies</a></li>
<li title="Changing Code for a Special Process"><a href="appup_cookbook.html#idp27360320">Changing Code for a Special Process</a></li>
<li title="Changing a Supervisor"><a href="appup_cookbook.html#idp27382160">Changing a Supervisor</a></li>
<li title="Adding or Deleting a Module"><a href="appup_cookbook.html#idp27413008">Adding or Deleting a Module</a></li>
<li title="Starting or Terminating a Process"><a href="appup_cookbook.html#idp27416336">Starting or Terminating a Process</a></li>
<li title="Adding or Removing an Application"><a href="appup_cookbook.html#idp27418576">Adding or Removing an Application</a></li>
<li title="Restarting an Application"><a href="appup_cookbook.html#idp27422256">Restarting an Application</a></li>
<li title="Changing an Application Specification"><a href="appup_cookbook.html#idp27427616">Changing an Application Specification</a></li>
<li title="Changing Application Configuration"><a href="appup_cookbook.html#idp27430464">Changing Application Configuration</a></li>
<li title="Changing Included Applications"><a href="appup_cookbook.html#idp27433792">Changing Included Applications</a></li>
<li title="Changing Non-Erlang Code"><a href="appup_cookbook.html#idp27465248">Changing Non-Erlang Code</a></li>
<li title="Emulator Restart and Upgrade"><a href="appup_cookbook.html#idp27476976">Emulator Restart and Upgrade</a></li>
<li title="Emulator Upgrade From Pre OTP R15"><a href="appup_cookbook.html#idp27487216">Emulator Upgrade From Pre OTP R15</a></li>
</ul>
</li>
</ul>
</div></div>
<div id="content">
<div class="innertube">
<h1>3 gen_fsm Behaviour</h1>
  
  <a name="gen_fsm%20behaviour"></a>
    <div class="note">
<div class="label">Note</div>
<div class="content"><p>
      <p>
	There is a new behaviour
	<span class="bold_code"><a href="statem.html"><span class="code">gen_statem</span></a></span>
	that is intended to replace <span class="code">gen_fsm</span> for new code.
	It has the same features and add some really useful.
	This module will not be removed for the foreseeable future
	to keep old state machine implementations running.
      </p>
    </p></div>
</div>
  <p>This section is to be read with the <span class="code">gen_fsm(3)</span> manual page
    in STDLIB, where all interface functions and callback
    functions are described in detail.</p>

  <h3><a name="idp25298816">3.1 
        Finite-State Machines</a></h3>
    
    <p>A Finite-State Machine (FSM) can be described as a set of
      relations of the form:</p>
    <div class="example"><pre>
State(S) x Event(E) -&gt; Actions(A), State(S')</pre></div>
    <p>These relations are interpreted as meaning:</p>
    <div class="quote"><p>
      <p>If we are in state <span class="code">S</span> and event <span class="code">E</span> occurs, we
        are to perform actions <span class="code">A</span> and make a transition to
        state <span class="code">S'</span>.</p>
    </p></div>
    <p>For an FSM implemented using the <span class="code">gen_fsm</span> behaviour,
      the state transition rules are written as a number of Erlang
      functions, which conform to the following convention:</p>
    <div class="example"><pre>
StateName(Event, StateData) -&gt;
    .. code for actions here ...
    {next_state, StateName', StateData'}</pre></div>
  

  <h3><a name="idp24804416">3.2 
        Example</a></h3>
    
    <p>A door with a code lock can be viewed as an FSM. Initially,
      the door is locked. Anytime someone presses a button, this
      generates an event. Depending on what buttons have been pressed
      before, the sequence so far can be correct, incomplete, or wrong.</p>
    <p>If it is correct, the door is unlocked for 30 seconds (30,000 ms).
      If it is incomplete, we wait for another button to be pressed. If
      it is is wrong, we start all over, waiting for a new button
      sequence.</p>
    <p>Implementing the code lock FSM using <span class="code">gen_fsm</span> results in
      the following callback module:</p>
    <a name="ex"></a>
    <div class="example"><pre>
-module(code_lock).
-behaviour(gen_fsm).

-export([start_link/1]).
-export([button/1]).
-export([init/1, locked/2, open/2]).

start_link(Code) -&gt;
    gen_fsm:start_link({local, code_lock}, code_lock, lists:reverse(Code), []).

button(Digit) -&gt;
    gen_fsm:send_event(code_lock, {button, Digit}).

init(Code) -&gt;
    {ok, locked, {[], Code}}.

locked({button, Digit}, {SoFar, Code}) -&gt;
    case [Digit|SoFar] of
        Code -&gt;
            do_unlock(),
            {next_state, open, {[], Code}, 30000};
        Incomplete when length(Incomplete)&lt;length(Code) -&gt;
            {next_state, locked, {Incomplete, Code}};
        _Wrong -&gt;
            {next_state, locked, {[], Code}}
    end.

open(timeout, State) -&gt;
    do_lock(),
    {next_state, locked, State}.</pre></div>
    <p>The code is explained in the next sections.</p>
  

  <h3><a name="idp24621488">3.3 
        Starting gen_fsm</a></h3>
    
    <p>In the example in the previous section, the <span class="code">gen_fsm</span> is
      started by calling <span class="code">code_lock:start_link(Code)</span>:</p>
    <div class="example"><pre>
start_link(Code) -&gt;
    gen_fsm:start_link({local, code_lock}, code_lock, lists:reverse(Code), []).
    </pre></div>
    <p><span class="code">start_link</span> calls the function <span class="code">gen_fsm:start_link/4</span>,
    which spawns and links to a new process, a <span class="code">gen_fsm</span>.</p>
    <ul>
      <li>
        <p>The first argument, <span class="code">{local, code_lock}</span>, specifies
          the name. In this case, the <span class="code">gen_fsm</span> is locally
	  registered as <span class="code">code_lock</span>.</p>
        <p>If the name is omitted, the <span class="code">gen_fsm</span> is not registered.
          Instead its pid must be used. The name can also be given
	  as <span class="code">{global, Name}</span>, in which case the <span class="code">gen_fsm</span> is
	  registered using <span class="code">global:register_name/2</span>.</p>
      </li>
      <li>
        <p>The second argument, <span class="code">code_lock</span>, is the name of
          the callback module, that is, the module where the callback
          functions are located.</p>
        <p>The interface functions (<span class="code">start_link</span> and <span class="code">button</span>)
	  are then located in the same module as the callback
          functions (<span class="code">init</span>, <span class="code">locked</span>, and <span class="code">open</span>). This
          is normally good programming practice, to have the code
          corresponding to one process contained in one module.</p>
      </li>
      <li>
        <p>The third argument, <span class="code">Code</span>, is a list of digits that
	  which is passed reversed to the callback function <span class="code">init</span>.
	  Here, <span class="code">init</span>
          gets the correct code for the lock as indata.</p>
      </li>
      <li>
        <p>The fourth argument, <span class="code">[]</span>, is a list of options. See
          the <span class="code">gen_fsm(3)</span> manual page for available options.</p>
      </li>
    </ul>
    <p>If name registration succeeds, the new <span class="code">gen_fsm</span> process calls
      the callback function <span class="code">code_lock:init(Code)</span>. This function
      is expected to return <span class="code">{ok, StateName, StateData}</span>, where
      <span class="code">StateName</span> is the name of the initial state of the
      <span class="code">gen_fsm</span>. In this case <span class="code">locked</span>, assuming the door is
      locked to begin with. <span class="code">StateData</span> is the internal state of
      the <span class="code">gen_fsm</span>. (For <span class="code">gen_fsm</span>, the internal state is
      often referred to 'state data' to
      distinguish it from the state as in states of a state machine.)
      In this case, the state data is the button sequence so far (empty
      to begin with) and the correct code of the lock.</p>
    <div class="example"><pre>
init(Code) -&gt;
    {ok, locked, {[], Code}}.</pre></div>
    <p><span class="code">gen_fsm:start_link</span> is synchronous. It does not return until
    the <span class="code">gen_fsm</span> has been initialized and is ready to
      receive notifications.</p>
    <p><span class="code">gen_fsm:start_link</span> must be used if the <span class="code">gen_fsm</span> is
      part of a supervision tree, that is, started by a supervisor. There
      is another function, <span class="code">gen_fsm:start</span>, to start a standalone
      <span class="code">gen_fsm</span>, that is, a <span class="code">gen_fsm</span> that is not part of a
      supervision tree.</p>
  

  <h3><a name="idp24412112">3.4 
        Notifying about Events</a></h3>
    
    <p>The function notifying the code lock about a button event is
      implemented using <span class="code">gen_fsm:send_event/2</span>:</p>
    <div class="example"><pre>
button(Digit) -&gt;
    gen_fsm:send_event(code_lock, {button, Digit}).</pre></div>
    <p><span class="code">code_lock</span> is the name of the <span class="code">gen_fsm</span> and must
      agree with the name used to start it.
      <span class="code">{button, Digit}</span> is the actual event.</p>
    <p>The event is made into a message and sent to the <span class="code">gen_fsm</span>.
      When the event is received, the <span class="code">gen_fsm</span> calls
      <span class="code">StateName(Event, StateData)</span>, which is expected to return a
      tuple <span class="code">{next_state,StateName1,StateData1}</span>.
      <span class="code">StateName</span> is the name of the current state and
      <span class="code">StateName1</span> is the name of the next state to go to.
      <span class="code">StateData1</span> is a new value for the state data of
      the <span class="code">gen_fsm</span>.</p>
    <div class="example"><pre>
locked({button, Digit}, {SoFar, Code}) -&gt;
    case [Digit|SoFar] of
        Code -&gt;
            do_unlock(),
            {next_state, open, {[], Code}, 30000};
        Incomplete when length(Incomplete)&lt;length(Code) -&gt;
            {next_state, locked, {Incomplete, Code}};
        _Wrong -&gt;
            {next_state, locked, {[], Code}};
    end.

open(timeout, State) -&gt;
    do_lock(),
    {next_state, locked, State}.</pre></div>
    <p>If the door is locked and a button is pressed, the complete
      button sequence so far is compared with the correct code for
      the lock and, depending on the result, the door is either unlocked
      and the <span class="code">gen_fsm</span> goes to state <span class="code">open</span>, or the door
      remains in state <span class="code">locked</span>.</p>
  

  <h3><a name="idp24409904">3.5 
        Time-Outs</a></h3>
    
    <p>When a correct code has been given, the door is unlocked and
      the following tuple is returned from <span class="code">locked/2</span>:</p>
    <div class="example"><pre>
{next_state, open, {[], Code}, 30000};</pre></div>
    <p>30,000 is a time-out value in milliseconds. After this time,
      that is, 30 seconds, a time-out occurs. Then,
      <span class="code">StateName(timeout, StateData)</span> is called. The time-out
      then occurs when the door has been in state <span class="code">open</span> for 30
      seconds. After that the door is locked again:</p>
    <div class="example"><pre>
open(timeout, State) -&gt;
    do_lock(),
    {next_state, locked, State}.</pre></div>
  

  <h3><a name="idp25748400">3.6 
        All State Events</a></h3>
    
    <p>Sometimes an event can arrive at any state of the <span class="code">gen_fsm</span>.
      Instead of sending the message with <span class="code">gen_fsm:send_event/2</span>
      and writing one clause handling the event for each state function,
      the message can be sent with <span class="code">gen_fsm:send_all_state_event/2</span>
      and handled with <span class="code">Module:handle_event/3</span>:</p>
    <div class="example"><pre>
-module(code_lock).
...
-export([stop/0]).
...

stop() -&gt;
    gen_fsm:send_all_state_event(code_lock, stop).

...

handle_event(stop, _StateName, StateData) -&gt;
    {stop, normal, StateData}.</pre></div>
  

  <h3><a name="idp25589072">3.7 
        Stopping</a></h3>
    

    <h4>In a Supervision Tree</h4>
      
      <p>If the <span class="code">gen_fsm</span> is part of a supervision tree, no stop
        function is needed. The <span class="code">gen_fsm</span> is automatically
	terminated by its supervisor. Exactly how this is done is
	defined by a
	<span class="bold_code"><a href="sup_princ.html#shutdown">shutdown strategy</a></span>
        set in the supervisor.</p>
      <p>If it is necessary to clean up before termination, the shutdown
        strategy must be a time-out value and the <span class="code">gen_fsm</span> must be
	set to trap exit signals in the <span class="code">init</span> function. When ordered
        to shutdown, the <span class="code">gen_fsm</span> then calls the callback function
        <span class="code">terminate(shutdown, StateName, StateData)</span>:</p>
      <div class="example"><pre>
init(Args) -&gt;
    ...,
    process_flag(trap_exit, true),
    ...,
    {ok, StateName, StateData}.

...

terminate(shutdown, StateName, StateData) -&gt;
    ..code for cleaning up here..
    ok.</pre></div>
    

    <h4>Standalone gen_fsm</h4>
      
      <p>If the <span class="code">gen_fsm</span> is not part of a supervision tree, a stop
        function can be useful, for example:</p>
      <div class="example"><pre>
...
-export([stop/0]).
...

stop() -&gt;
    gen_fsm:send_all_state_event(code_lock, stop).
...

handle_event(stop, _StateName, StateData) -&gt;
    {stop, normal, StateData}.

...

terminate(normal, _StateName, _StateData) -&gt;
    ok.</pre></div>
      <p>The callback function handling the <span class="code">stop</span> event returns a
        tuple, <span class="code">{stop,normal,StateData1}</span>, where <span class="code">normal</span>
        specifies that it is a normal termination and <span class="code">StateData1</span>
        is a new value for the state data of the <span class="code">gen_fsm</span>. This
        causes the <span class="code">gen_fsm</span> to call
        <span class="code">terminate(normal,StateName,StateData1)</span> and then
        it terminates gracefully:</p>
    
  

  <h3><a name="idp25500848">3.8 
        Handling Other Messages</a></h3>
    
    <p>If the <span class="code">gen_fsm</span> is to be able to receive other messages
      than events, the callback function
      <span class="code">handle_info(Info, StateName, StateData)</span> must be implemented
      to handle them. Examples of
      other messages are exit messages, if the <span class="code">gen_fsm</span> is linked to
      other processes (than the supervisor) and trapping exit signals.</p>
    <div class="example"><pre>
handle_info({'EXIT', Pid, Reason}, StateName, StateData) -&gt;
    ..code to handle exits here..
    {next_state, StateName1, StateData1}.</pre></div>
    <p>The code_change method must also be implemented.</p>
    <div class="example"><pre>
code_change(OldVsn, StateName, StateData, Extra) -&gt;
    ..code to convert state (and more) during code change
    {ok, NextStateName, NewStateData}</pre></div>
  
</div>
<div class="footer">
<hr>
<p>Copyright © 1997-2018 Ericsson AB. All Rights Reserved.</p>
</div>
</div>
</div></body>
</html>
